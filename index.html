<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Sticky Notes App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Define CSS custom properties for dynamic theming */
        :root {
            --primary-color: #6366f1; /* Indigo 500 */
            --secondary-color: #a78bfa; /* Violet 400 */
            --note-bg-color: #ffe87a; /* Light yellow for notes */
        }

        /* Apply Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* Dynamic gradient background using custom properties */
        .bg-custom-gradient {
            background-image: linear-gradient(to right, var(--primary-color), var(--secondary-color));
        }

        /* Apply custom colors to elements using custom properties */
        .text-primary-color {
            color: var(--primary-color);
        }
        .bg-primary-color {
            background-color: var(--primary-color);
        }
        .bg-secondary-color {
            background-color: var(--secondary-color);
        }
        .border-primary-color {
            border-color: var(--primary-color);
        }
        .bg-note-color {
            background-color: var(--note-bg-color);
        }

        /* Animations for card hover */
        .card {
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        /* Custom scrollbar for panel */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Custom alert message box styles */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none; /* Allows clicks to pass through */
        }
        .message-box.show {
            opacity: 1;
            pointer-events: auto;
        }

        /* Notes Canvas */
        #notes-canvas {
            position: relative;
            min-height: 70vh; /* Make canvas large enough to drag things around */
            border: 2px dashed #cbd5e1; /* Gray 300 */
            border-radius: 1rem; /* rounded-xl */
            background-color: #f8fafc; /* Slate 50 */
            overflow: hidden; /* To prevent draggable elements from going outside */
        }

        /* Draggable/Resizable Category */
        .category-box {
            position: absolute;
            min-width: 250px;
            min-height: 150px;
            background-color: #e0f2f7; /* Light Blue */
            border: 1px solid #90cdf4; /* Blue 300 */
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            cursor: grab;
            display: flex;
            flex-direction: column;
            resize: both; /* Allow resizing */
            overflow: hidden; /* Hide overflow for notes within */
            padding: 1rem;
            z-index: 10;
            transition: box-shadow 0.1s ease-in-out;
        }
        .category-box:active {
            cursor: grabbing;
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.2);
        }
        .category-header {
            font-weight: bold;
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            cursor: move; /* Indicate header is for dragging */
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .category-notes-container {
            flex-grow: 1;
            overflow-y: auto; /* Scroll for notes inside category */
            padding-right: 0.5rem; /* Space for scrollbar */
        }
        .category-notes-container::-webkit-scrollbar {
            width: 6px;
        }
        .category-notes-container::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 10px;
        }
        .category-notes-container::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
        .category-notes-container::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 0, 0, 0.4);
        }

        /* Draggable Note */
        .note-box {
            background-color: var(--note-bg-color);
            border: 1px solid #d6bc3a; /* Yellow 600 */
            border-radius: 0.5rem; /* rounded-md */
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: text; /* Indicate editable text */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: box-shadow 0.1s ease-in-out;
            word-wrap: break-word; /* Ensure text wraps */
        }
        .note-box:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        /* Delete Buttons for Category and Note */
        .delete-btn {
            background-color: #ef4444; /* Red 500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s ease-in-out;
        }
        .delete-btn:hover {
            background-color: #dc2626; /* Red 600 */
        }
        .add-note-btn {
            background-color: #22c55e; /* Green 500 */
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            margin-top: 0.5rem;
            transition: background-color 0.2s ease-in-out;
        }
        .add-note-btn:hover {
            background-color: #16a34a; /* Green 600 */
        }

        /* Auth Modal Specific Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        /* Loading overlay styles */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000; /* Higher than other modals */
            font-size: 1.5rem;
            color: var(--primary-color);
        }
        .spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid var(--primary-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, deleteDoc, updateDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables for Firebase
        window.firebaseApp = null;
        window.db = null;
        window.auth = null;
        window.userId = null;
        // Directly embed your Firebase Config for publishable version
        const firebaseConfig = {
            apiKey: "AIzaSyBm00uFk4lPTLbzhvdU7DFExqhvySeKIC8",
            authDomain: "notesapp-643cd.firebaseapp.com",
            projectId: "notesapp-643cd",
            storageBucket: "notesapp-643cd.firebasestorage.app",
            messagingSenderId: "599886933610",
            appId: "1:599886933610:web:708c30f834c460324b6413",
            measurementId: "G-GY7LYN8ECF" // measurementId is optional and not used in this app's core logic
        };
        // Use projectId as the appId for Firestore paths in a standalone environment
        window.appId = firebaseConfig.projectId;


        // Message Box Function
        function showMessage(message, duration = 3000) {
            const messageBox = document.getElementById('messageBox');
            if (messageBox) {
                messageBox.textContent = message;
                messageBox.classList.add('show');
                setTimeout(() => {
                    messageBox.classList.remove('show');
                }, duration);
            }
        }

        window.onload = async () => {
            try {
                // Initialize Firebase with the embedded config
                window.firebaseApp = initializeApp(firebaseConfig);
                window.db = getFirestore(window.firebaseApp);
                window.auth = getAuth(window.firebaseApp);

                // Show loading indicator or splash screen while authenticating
                const loadingOverlay = document.getElementById('loadingOverlay');
                loadingOverlay.classList.remove('hidden');

                // Listen for auth state changes
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.userId = user.uid; // Set global userId
                        document.getElementById('displayUserId').textContent = `User ID: ${window.userId}`;
                        console.log("Authenticated as:", window.userId);

                        try {
                            // Check if password has been set for this anonymous user
                            const userProfileRef = doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'settings', 'userProfile');
                            console.log("Attempting to fetch user profile for:", window.userId);
                            const userProfileSnap = await getDoc(userProfileRef);
                            console.log("User profile snapshot exists:", userProfileSnap.exists());

                            loadingOverlay.classList.add('hidden'); // Hide loading

                            if (userProfileSnap.exists() && userProfileSnap.data().passwordHash) {
                                // Password already set, hide auth modal, show app
                                document.getElementById('authModal').classList.add('hidden');
                                document.getElementById('mainAppContent').classList.remove('hidden');
                                showMessage("Welcome back! Loading your notes...");
                                setupNoteListeners(); // Start listening for notes
                                attachMainAppEventListeners(); // Attach event listeners for main app elements
                            } else {
                                // First time or password not set, show password creation modal
                                document.getElementById('authModal').classList.remove('hidden');
                                document.getElementById('mainAppContent').classList.add('hidden');
                                document.getElementById('passwordForm').classList.remove('hidden'); // Show set password form
                                document.getElementById('loginForm').classList.add('hidden'); // Hide login form
                                document.getElementById('authMessage').textContent = 'Welcome! Please set a password to secure your notes.';
                            }
                        } catch (profileError) {
                            console.error("Error fetching user profile:", profileError);
                            showMessage(`Failed to load profile: ${profileError.message}. Please check Firebase rules.`);
                            loadingOverlay.classList.add('hidden'); // Ensure loading is hidden on profile fetch error
                        }
                    } else {
                        // Not authenticated, sign in anonymously
                        try {
                            await signInAnonymously(window.auth);
                            console.log("Signed in anonymously.");
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            showMessage(`Authentication failed: ${error.message}`);
                            loadingOverlay.classList.add('hidden');
                        }
                    }
                });

                // Function to hash password (client-side)
                async function hashPassword(password) {
                    const textEncoder = new TextEncoder();
                    const data = textEncoder.encode(password);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    const hashedPassword = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    return hashedPassword;
                }

                // Password Setup/Login Handlers
                document.getElementById('setPasswordBtn').addEventListener('click', async () => {
                    const passwordInput = document.getElementById('newPassword').value;
                    const confirmPasswordInput = document.getElementById('confirmNewPassword').value;
                    if (passwordInput.length < 8) {
                        showMessage("Password must be at least 8 characters long.");
                        return;
                    }
                    if (passwordInput !== confirmPasswordInput) {
                        showMessage("Passwords do not match.");
                        return;
                    }

                    try {
                        const hashedPassword = await hashPassword(passwordInput);
                        const userProfileRef = doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'settings', 'userProfile');
                        await setDoc(userProfileRef, { passwordHash: hashedPassword, createdAt: new Date().toISOString() }, { merge: true });
                        document.getElementById('authModal').classList.add('hidden');
                        document.getElementById('mainAppContent').classList.remove('hidden');
                        showMessage("Password set successfully! Welcome to your notes.");
                        setupNoteListeners(); // Start listening for notes
                        attachMainAppEventListeners(); // Attach event listeners for main app elements
                    } catch (error) {
                        console.error("Error setting password:", error);
                        showMessage(`Failed to set password: ${error.message}`);
                    }
                });

                document.getElementById('loginBtn').addEventListener('click', async () => {
                    const passwordInput = document.getElementById('loginPassword').value;
                    if (passwordInput.length === 0) {
                        showMessage("Please enter your password.");
                        return;
                    }

                    try {
                        const userProfileRef = doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'settings', 'userProfile');
                        const userProfileSnap = await getDoc(userProfileRef);

                        if (userProfileSnap.exists() && userProfileSnap.data().passwordHash) {
                            const storedHash = userProfileSnap.data().passwordHash;
                            const enteredHash = await hashPassword(passwordInput);

                            if (storedHash === enteredHash) {
                                document.getElementById('authModal').classList.add('hidden');
                                document.getElementById('mainAppContent').classList.remove('hidden');
                                showMessage("Login successful! Welcome back.");
                                setupNoteListeners(); // Start listening for notes
                                attachMainAppEventListeners(); // Attach event listeners for main app elements
                            } else {
                                showMessage("Incorrect password. Please try again.");
                            }
                        } else {
                            showMessage("No password set for this user. Please set one first.");
                        }
                    } catch (error) {
                        console.error("Error logging in:", error);
                        showMessage(`Login failed: ${error.message}`);
                    }
                });

                // Toggle between set password and login forms
                document.getElementById('showLoginLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('passwordForm').classList.add('hidden');
                    document.getElementById('loginForm').classList.remove('hidden');
                    document.getElementById('authMessage').textContent = 'Please enter your password to access your notes.';
                });

                document.getElementById('showSetPasswordLink').addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('loginForm').classList.add('hidden');
                    document.getElementById('passwordForm').classList.remove('hidden');
                    document.getElementById('authMessage').textContent = 'Welcome! Please set a password to secure your notes.';
                });

                // Function to attach event listeners for main app content once it's visible
                function attachMainAppEventListeners() {
                    // Logout button functionality
                    document.getElementById('logoutBtn').addEventListener('click', async () => {
                        try {
                            await signOut(window.auth);
                            showMessage("Logged out successfully. You can close this tab or sign in again.");
                            // Clear UI and show auth modal again
                            document.getElementById('notes-canvas').innerHTML = ''; // Clear notes
                            document.getElementById('mainAppContent').classList.add('hidden');
                            document.getElementById('authModal').classList.remove('hidden');
                            document.getElementById('loginForm').classList.remove('hidden'); // Show login form
                            document.getElementById('passwordForm').classList.add('hidden'); // Hide set password form
                            document.getElementById('authMessage').textContent = 'Please enter your password to access your notes.';
                        } catch (error) {
                            console.error("Logout error:", error);
                            showMessage(`Logout failed: ${error.message}`);
                        }
                    });

                    // Add Category button event listener
                    document.getElementById('addCategoryBtn').addEventListener('click', async () => {
                        if (!window.userId) { showMessage("Please authenticate first."); return; }
                        const categoryName = prompt("Enter category name:");
                        if (categoryName) {
                            try {
                                // Add a new category document to Firestore
                                const newCategoryRef = await addDoc(collection(window.db, 'artifacts', window.appId, 'users', window.userId, 'categories'), {
                                    name: categoryName,
                                    x: 50, // Default position
                                    y: 50, // Default position
                                    width: 300,
                                    height: 200,
                                    zIndex: currentZIndex + 1,
                                    createdAt: new Date().toISOString()
                                });
                                showMessage(`Category "${categoryName}" added!`);
                            } catch (error) {
                                console.error("Error adding category:", error);
                                showMessage(`Failed to add category: ${error.message}`);
                            }
                        }
                    });
                }


                // --- Note/Category App Logic ---
                const notesCanvas = document.getElementById('notes-canvas');
                let activeDragElement = null;
                let isResizing = false; // This variable is not actively used for custom resize logic but kept for context.
                let initialX, initialY;
                let currentZIndex = 10; // To manage layering of elements

                // Function to bring an element to the front
                function bringToFront(element) {
                    currentZIndex++;
                    element.style.zIndex = currentZIndex;
                }

                // Function to create a category DOM element
                function createCategoryElement(categoryData) {
                    const categoryBox = document.createElement('div');
                    categoryBox.className = 'category-box';
                    categoryBox.id = `category-${categoryData.id}`;
                    categoryBox.style.left = `${categoryData.x}px`;
                    categoryBox.style.top = `${categoryData.y}px`;
                    categoryBox.style.width = `${categoryData.width}px`;
                    categoryBox.style.height = `${categoryData.height}px`;
                    categoryBox.style.zIndex = categoryData.zIndex || 10;
                    bringToFront(categoryBox); // Bring newly created/updated to front

                    categoryBox.innerHTML = `
                        <div class="category-header">
                            <span contenteditable="true" class="category-name-edit">${categoryData.name}</span>
                            <div class="flex space-x-2">
                                <button class="add-note-btn">Add Note</button>
                                <button class="delete-btn">X</button>
                            </div>
                        </div>
                        <div class="category-notes-container" id="notes-in-category-${categoryData.id}">
                            <!-- Notes will be appended here -->
                        </div>
                    `;

                    // Handle dragging for the category box (header part)
                    const header = categoryBox.querySelector('.category-header');
                    header.addEventListener('mousedown', (e) => {
                        // Check if click is on buttons or editable text within the header
                        if (e.target.classList.contains('add-note-btn') || e.target.classList.contains('delete-btn') || e.target.classList.contains('category-name-edit')) {
                            return; // Don't initiate drag if clicking on these specific elements
                        }
                        activeDragElement = categoryBox;
                        initialX = e.clientX - categoryBox.getBoundingClientRect().left;
                        initialY = e.clientY - categoryBox.getBoundingClientRect().top;
                        bringToFront(categoryBox); // Bring dragged category to front
                    });

                    // Update category name
                    const categoryNameEdit = categoryBox.querySelector('.category-name-edit');
                    categoryNameEdit.addEventListener('blur', async () => {
                        const newName = categoryNameEdit.textContent.trim();
                        if (newName !== categoryData.name) {
                            try {
                                await updateDoc(doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'categories', categoryData.id), {
                                    name: newName
                                });
                                showMessage(`Category name updated to "${newName}".`);
                            } catch (error) {
                                console.error("Error updating category name:", error);
                                showMessage("Failed to update category name.");
                            }
                        }
                    });

                    // Delete category button
                    categoryBox.querySelector('.delete-btn').addEventListener('click', async () => {
                        // Using custom modal message instead of browser's confirm()
                        const confirmationModal = document.createElement('div');
                        confirmationModal.className = 'modal-overlay';
                        confirmationModal.innerHTML = `
                            <div class="modal-content">
                                <p class="text-lg mb-4">Are you sure you want to delete category "${categoryData.name}" and all its notes?</p>
                                <div class="flex justify-center space-x-4">
                                    <button id="confirmDeleteCategory" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Yes, Delete</button>
                                    <button id="cancelDeleteCategory" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Cancel</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(confirmationModal);

                        document.getElementById('confirmDeleteCategory').addEventListener('click', async () => {
                            try {
                                // Delete all notes within this category first
                                const notesQuery = query(collection(window.db, 'artifacts', window.appId, 'users', window.userId, 'notes'), where("categoryId", "==", categoryData.id));
                                const notesSnapshot = await getDocs(notesQuery);
                                const deleteNotePromises = notesSnapshot.docs.map(nDoc => deleteDoc(nDoc.ref));
                                await Promise.all(deleteNotePromises);

                                // Then delete the category itself
                                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'categories', categoryData.id));
                                showMessage(`Category "${categoryData.name}" and its notes deleted.`);
                            } catch (error) {
                                console.error("Error deleting category and notes:", error);
                                showMessage(`Failed to delete category: ${error.message}`);
                            } finally {
                                confirmationModal.remove(); // Remove the modal
                            }
                        });

                        document.getElementById('cancelDeleteCategory').addEventListener('click', () => {
                            confirmationModal.remove(); // Remove the modal
                        });
                    });

                    // Add note button for this category
                    categoryBox.querySelector('.add-note-btn').addEventListener('click', async () => {
                        try {
                            const newNoteRef = await addDoc(collection(window.db, 'artifacts', window.appId, 'users', window.userId, 'notes'), {
                                categoryId: categoryData.id,
                                content: '', // Empty note content initially
                                createdAt: new Date().toISOString()
                            });
                            showMessage("New note added to category.");
                            // The onSnapshot listener for notes will render it
                        } catch (error) {
                            console.error("Error adding note:", error);
                            showMessage("Failed to add note.");
                        }
                    });

                    return categoryBox;
                }

                // Function to create a note DOM element
                function createNoteElement(noteData) {
                    const noteBox = document.createElement('div');
                    noteBox.className = 'note-box';
                    noteBox.id = `note-${noteData.id}`;
                    noteBox.setAttribute('contenteditable', 'true');
                    noteBox.textContent = noteData.content;
                    noteBox.style.zIndex = noteData.zIndex || 1; // Notes generally have lower z-index than categories

                    noteBox.addEventListener('blur', async () => {
                        const newContent = noteBox.textContent.trim();
                        // Ensure the delete button is not part of the content when saving
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = noteBox.innerHTML;
                        const deleteBtn = tempDiv.querySelector('.delete-btn');
                        if (deleteBtn) {
                            deleteBtn.remove();
                        }
                        const contentToSave = tempDiv.textContent.trim();

                        if (contentToSave !== noteData.content) {
                            try {
                                await updateDoc(doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'notes', noteData.id), {
                                    content: contentToSave
                                });
                                showMessage("Note content updated.");
                            } catch (error) {
                                console.error("Error updating note content:", error);
                                showMessage("Failed to update note.");
                            }
                        }
                    });

                    // Add a delete button for the note
                    const deleteNoteBtn = document.createElement('button');
                    deleteNoteBtn.className = 'delete-btn ml-2 float-right'; // Tailwind classes for styling
                    deleteNoteBtn.textContent = 'X';
                    deleteNoteBtn.addEventListener('click', async (e) => {
                        e.stopPropagation(); // Prevent blur event on note contenteditable
                        // Using custom modal message instead of browser's confirm()
                        const confirmationModal = document.createElement('div');
                        confirmationModal.className = 'modal-overlay';
                        confirmationModal.innerHTML = `
                            <div class="modal-content">
                                <p class="text-lg mb-4">Are you sure you want to delete this note?</p>
                                <div class="flex justify-center space-x-4">
                                    <button id="confirmDeleteNote" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Yes, Delete</button>
                                    <button id="cancelDeleteNote" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Cancel</button>
                                </div>
                            </div>
                        `;
                        document.body.appendChild(confirmationModal);

                        document.getElementById('confirmDeleteNote').addEventListener('click', async () => {
                            try {
                                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'notes', noteData.id));
                                showMessage("Note deleted.");
                            } catch (error) {
                                console.error("Error deleting note:", error);
                                showMessage("Failed to delete note.");
                            } finally {
                                confirmationModal.remove(); // Remove the modal
                            }
                        });

                        document.getElementById('cancelDeleteNote').addEventListener('click', () => {
                            confirmationModal.remove(); // Remove the modal
                        });
                    });
                    noteBox.prepend(deleteNoteBtn); // Add delete button at the beginning

                    return noteBox;
                }

                // Global mouse move and up for dragging/resizing
                document.addEventListener('mousemove', (e) => {
                    if (activeDragElement) {
                        // Calculate new position
                        let newX = e.clientX - initialX;
                        let newY = e.clientY - initialY;

                        // Constrain within notesCanvas boundaries
                        const canvasRect = notesCanvas.getBoundingClientRect();
                        const elementRect = activeDragElement.getBoundingClientRect();

                        newX = Math.max(0, Math.min(newX, canvasRect.width - elementRect.width));
                        newY = Math.max(0, Math.min(newY, canvasRect.height - elementRect.height));

                        activeDragElement.style.left = `${newX}px`;
                        activeDragElement.style.top = `${newY}px`;
                    }
                });

                document.addEventListener('mouseup', async () => {
                    if (activeDragElement) {
                        const elementId = activeDragElement.id.split('-')[1]; // Get ID part
                        const elementType = activeDragElement.id.split('-')[0]; // "category" or "note"

                        const x = parseFloat(activeDragElement.style.left);
                        const y = parseFloat(activeDragElement.style.top);
                        const zIndex = parseFloat(activeDragElement.style.zIndex);
                        const width = activeDragElement.offsetWidth; // Get current rendered width
                        const height = activeDragElement.offsetHeight; // Get current rendered height

                        try {
                            if (elementType === 'category') {
                                await updateDoc(doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'categories', elementId), {
                                    x: x,
                                    y: y,
                                    width: width,
                                    height: height,
                                    zIndex: zIndex
                                });
                                showMessage("Category position and size saved.");
                            }
                        } catch (error) {
                            console.error(`Error updating ${elementType} position:`, error);
                            showMessage(`Failed to save ${elementType} position.`);
                        }
                        activeDragElement = null; // Reset active element
                        isResizing = false; // Reset resizing flag (not actively used for custom resize handles but good to reset)
                    }
                });


                // Main listener function for notes and categories
                function setupNoteListeners() {
                    // Listen for Categories
                    onSnapshot(collection(window.db, 'artifacts', window.appId, 'users', window.userId, 'categories'), (snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            const categoryData = { id: change.doc.id, ...change.doc.data() };
                            const existingCategoryEl = document.getElementById(`category-${categoryData.id}`);

                            if (change.type === "added") {
                                if (!existingCategoryEl) { // Only add if not already present
                                    const categoryElement = createCategoryElement(categoryData);
                                    notesCanvas.appendChild(categoryElement);
                                    console.log("Added category:", categoryData.id);
                                }
                            } else if (change.type === "modified") {
                                if (existingCategoryEl) {
                                    // Update position, size, zIndex, and name
                                    existingCategoryEl.style.left = `${categoryData.x}px`;
                                    existingCategoryEl.style.top = `${categoryData.y}px`;
                                    existingCategoryEl.style.width = `${categoryData.width}px`;
                                    existingCategoryEl.style.height = `${categoryData.height}px`;
                                    existingCategoryEl.style.zIndex = categoryData.zIndex;
                                    existingCategoryEl.querySelector('.category-name-edit').textContent = categoryData.name;
                                    console.log("Modified category:", categoryData.id);
                                }
                            } else if (change.type === "removed") {
                                if (existingCategoryEl) {
                                    existingCategoryEl.remove();
                                    console.log("Removed category:", categoryData.id);
                                }
                            }
                        });
                    });

                    // Listen for Notes (within categories)
                    onSnapshot(collection(window.db, 'artifacts', window.appId, 'users', window.userId, 'notes'), (snapshot) => {
                        snapshot.docChanges().forEach(change => {
                            const noteData = { id: change.doc.id, ...change.doc.data() };
                            const parentCategoryContainer = document.getElementById(`notes-in-category-${noteData.categoryId}`);
                            const existingNoteEl = document.getElementById(`note-${noteData.id}`);

                            if (!parentCategoryContainer) {
                                console.warn(`Parent category container for note ${noteData.id} not found. Note might be orphaned or category not loaded yet.`);
                                return;
                            }

                            if (change.type === "added") {
                                if (!existingNoteEl) {
                                    const noteElement = createNoteElement(noteData);
                                    parentCategoryContainer.appendChild(noteElement);
                                    console.log("Added note:", noteData.id);
                                }
                            } else if (change.type === "modified") {
                                if (existingNoteEl) {
                                    // Remove existing delete button if any before setting textContent
                                    const existingDeleteBtn = existingNoteEl.querySelector('.delete-btn');
                                    if (existingDeleteBtn) {
                                        existingDeleteBtn.remove();
                                    }
                                    existingNoteEl.textContent = noteData.content;
                                    // Re-add delete button as textContent replaces it
                                    const deleteBtn = document.createElement('button');
                                    deleteBtn.className = 'delete-btn ml-2 float-right';
                                    deleteBtn.textContent = 'X';
                                    deleteBtn.addEventListener('click', async (e) => {
                                        e.stopPropagation();
                                        const confirmationModal = document.createElement('div');
                                        confirmationModal.className = 'modal-overlay';
                                        confirmationModal.innerHTML = `
                                            <div class="modal-content">
                                                <p class="text-lg mb-4">Are you sure you want to delete this note?</p>
                                                <div class="flex justify-center space-x-4">
                                                    <button id="confirmDeleteNote" class="bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600">Yes, Delete</button>
                                                    <button id="cancelDeleteNote" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-400">Cancel</button>
                                                </div>
                                            </div>
                                        `;
                                        document.body.appendChild(confirmationModal);

                                        document.getElementById('confirmDeleteNote').addEventListener('click', async () => {
                                            try {
                                                await deleteDoc(doc(window.db, 'artifacts', window.appId, 'users', window.userId, 'notes', noteData.id));
                                                showMessage("Note deleted.");
                                            } catch (error) {
                                                console.error("Error deleting note:", error);
                                                showMessage("Failed to delete note.");
                                            } finally {
                                                confirmationModal.remove();
                                            }
                                        });
                                        document.getElementById('cancelDeleteNote').addEventListener('click', () => {
                                            confirmationModal.remove();
                                        });
                                    });
                                    existingNoteEl.prepend(deleteBtn);
                                    console.log("Modified note:", noteData.id);
                                }
                            } else if (change.type === "removed") {
                                if (existingNoteEl) {
                                    existingNoteEl.remove();
                                    console.log("Removed note:", noteData.id);
                                }
                            }
                        });
                    });
                }
            } catch (error) {
                console.error("Initialization Error:", error);
                showMessage(`App failed to load: ${error.message}. Please check console.`);
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        };

        // --- Customization Panel Logic (from previous version, adapted) ---
        const root = document.documentElement;
        const customizationPanel = document.getElementById('customizationPanel');
        const openPanelBtn = document.getElementById('openPanelBtn');
        const closePanelBtn = document.getElementById('closePanelBtn');
        const primaryColorPicker = document.getElementById('primaryColorPicker');
        const secondaryColorPicker = document.getElementById('secondaryColorPicker');
        const gradientDirection = document.getElementById('gradientDirection');
        const resetColorsBtn = document.getElementById('resetColorsBtn');
        const header = document.querySelector('header');
        const ctaSection = document.querySelector('.bg-custom-gradient-reverse'); // This section is now just a placeholder in the note app, but keeping the styling logic

        function updateColors(primary, secondary, direction) {
            root.style.setProperty('--primary-color', primary);
            root.style.setProperty('--secondary-color', secondary);

            // Update header background gradient
            if (header) {
                header.style.backgroundImage = `linear-gradient(${direction}, ${primary}, ${secondary})`;
            }

            // Update CTA section background gradient (if applicable, otherwise no-op)
            let reverseDirection;
            if (direction === 'to right') reverseDirection = 'to left';
            else if (direction === 'to left') reverseDirection = 'to right';
            else if (direction === 'to top') reverseDirection = 'to bottom';
            else if (direction === 'to bottom') reverseDirection = 'to top';
            else if (direction === 'to top right') reverseDirection = 'to bottom left';
            else if (direction === 'to bottom left') reverseDirection = 'to top right';
            else reverseDirection = 'to right'; // Default fallback

            if (ctaSection) { // Ensure CTA section exists (it's hidden in this version)
                 ctaSection.style.backgroundImage = `linear-gradient(${reverseDirection}, ${secondary}, ${primary})`;
            }
        }

        primaryColorPicker.addEventListener('input', (event) => {
            updateColors(event.target.value, secondaryColorPicker.value, gradientDirection.value);
        });

        secondaryColorPicker.addEventListener('input', (event) => {
            updateColors(primaryColorPicker.value, event.target.value, gradientDirection.value);
        });

        gradientDirection.addEventListener('change', (event) => {
            updateColors(primaryColorPicker.value, secondaryColorPicker.value, event.target.value);
        });

        openPanelBtn.addEventListener('click', () => {
            customizationPanel.classList.remove('translate-x-full');
            customizationPanel.classList.add('translate-x-0');
        });
        closePanelBtn.addEventListener('click', () => {
            customizationPanel.classList.remove('translate-x-0');
            customizationPanel.classList.add('translate-x-full');
        });

        resetColorsBtn.addEventListener('click', () => {
            const defaultPrimary = '#6366f1';
            const defaultSecondary = '#a78bfa';
            const defaultDirection = 'to right';

            primaryColorPicker.value = defaultPrimary;
            secondaryColorPicker.value = defaultSecondary;
            gradientDirection.value = defaultDirection;
            updateColors(defaultPrimary, defaultSecondary, defaultDirection);
            showMessage("Colors have been reset to default.");
        });

        // Initialize colors on customization panel load (if not handled by window.onload)
        document.addEventListener('DOMContentLoaded', () => {
            // Only initialize colors here if Firebase hasn't already done it via onAuthStateChanged
            // which sets up the header gradient. If Firebase hasn't run yet, apply defaults.
            if (!window.firebaseApp) {
                const initialPrimary = primaryColorPicker.value;
                const initialSecondary = secondaryColorPicker.value;
                const initialDirection = gradientDirection.value;
                updateColors(initialPrimary, initialSecondary, initialDirection);
            }
        });

    </script>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden">
        <div class="spinner"></div>
        <p>Loading your notes...</p>
    </div>

    <!-- Message Box -->
    <div id="messageBox" class="message-box"></div>

    <!-- Authentication Modal -->
    <div id="authModal" class="modal-overlay hidden">
        <div class="modal-content">
            <h2 class="text-3xl font-bold mb-4 text-primary-color">Welcome to Sticky Notes!</h2>
            <p id="authMessage" class="text-gray-700 mb-6"></p>

            <!-- Set Password Form -->
            <div id="passwordForm" class="hidden">
                <div class="mb-4">
                    <input type="password" id="newPassword" placeholder="New Password (min 8 characters)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-color" minlength="8">
                </div>
                <div class="mb-6">
                    <input type="password" id="confirmNewPassword" placeholder="Confirm New Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-color">
                </div>
                <button id="setPasswordBtn" class="bg-primary-color text-white px-6 py-3 rounded-lg w-full hover:bg-indigo-700 transition duration-300">Set Password</button>
                <p class="mt-4 text-sm text-gray-600">Already set a password? <a href="#" id="showLoginLink" class="text-primary-color hover:underline">Sign In</a></p>
            </div>

            <!-- Login Form -->
            <div id="loginForm" class="hidden">
                <div class="mb-6">
                    <input type="password" id="loginPassword" placeholder="Your Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-color">
                </div>
                <button id="loginBtn" class="bg-primary-color text-white px-6 py-3 rounded-lg w-full hover:bg-indigo-700 transition duration-300">Login</button>
                <p class="mt-4 text-sm text-gray-600">First time here? <a href="#" id="showSetPasswordLink" class="text-primary-color hover:underline">Set a Password</a></p>
            </div>
        </div>
    </div>


    <!-- Main Application Content -->
    <div id="mainAppContent" class="hidden flex flex-col flex-grow">
        <!-- Header Section -->
        <header class="bg-custom-gradient text-white p-6 md:p-8 shadow-lg rounded-b-xl mb-8 transition-all duration-500 ease-in-out">
            <div class="container mx-auto flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl md:text-4xl font-bold mb-4 md:mb-0">Universal Sticky Notes</h1>
                <div class="flex items-center space-x-4">
                    <span id="displayUserId" class="text-sm text-gray-200 truncate"></span>
                    <button id="logoutBtn" class="bg-white text-primary-color px-4 py-2 rounded-full text-sm font-semibold hover:bg-gray-200 transition duration-300">Logout</button>
                </div>
            </div>
        </header>

        <!-- Main Content Section -->
        <main class="container mx-auto p-4 flex-grow">
            <section class="text-center mb-6">
                <button id="addCategoryBtn" class="bg-green-500 text-white px-6 py-3 rounded-full text-lg font-semibold shadow-lg hover:bg-green-600 transform hover:-translate-y-1 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-green-500 focus:ring-opacity-50">
                    Add New Category
                </button>
            </section>

            <!-- Notes Canvas -->
            <div id="notes-canvas" class="min-h-[70vh] w-full mb-8">
                <!-- Categories and Notes will be rendered here dynamically -->
            </div>

            <!-- Placeholder for old CTA section, kept for color update logic -->
            <section class="bg-gray-800 text-white p-10 rounded-xl shadow-lg text-center hidden bg-custom-gradient-reverse transition-all duration-500 ease-in-out">
                <h2 class="text-3xl md:text-4xl font-bold mb-4">Hidden CTA Section</h2>
                <p class="text-lg mb-6">This section is hidden in the notes app.</p>
            </section>
        </main>

        <!-- Footer Section -->
        <footer class="bg-gray-800 text-white p-6 md:p-8 mt-8 rounded-t-xl shadow-lg">
            <div class="container mx-auto text-center text-gray-400">
                &copy; 2025 Universal Sticky Notes. All rights reserved.
            </div>
        </footer>

        <!-- Customization Panel -->
        <div id="customizationPanel" class="fixed right-0 top-0 h-full w-72 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out z-50 rounded-l-xl flex flex-col custom-scrollbar">
            <div class="flex justify-between items-center p-4 border-b border-gray-200 bg-gray-50 rounded-tl-xl">
                <h3 class="text-xl font-semibold text-gray-800">Customize Theme</h3>
                <button id="closePanelBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div class="p-4 flex-grow overflow-y-auto">
                <div class="mb-6">
                    <label for="primaryColorPicker" class="block text-gray-700 text-sm font-bold mb-2">Primary Color:</label>
                    <input type="color" id="primaryColorPicker" value="#6366f1" class="w-full h-10 border border-gray-300 rounded-lg p-1">
                </div>
                <div class="mb-6">
                    <label for="secondaryColorPicker" class="block text-gray-700 text-sm font-bold mb-2">Secondary Color:</label>
                    <input type="color" id="secondaryColorPicker" value="#a78bfa" class="w-full h-10 border border-gray-300 rounded-lg p-1">
                </div>
                <div class="mb-6">
                    <label for="gradientDirection" class="block text-gray-700 text-sm font-bold mb-2">Gradient Direction:</label>
                    <select id="gradientDirection" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-primary-color focus:border-primary-color">
                        <option value="to right">To Right</option>
                        <option value="to left">To Left</option>
                        <option value="to top">To Top</option>
                        <option value="to bottom">To Bottom</option>
                        <option value="to top right">To Top Right</option>
                        <option value="to bottom left">To Bottom Left</option>
                    </select>
                </div>
                <div class="mb-6">
                    <button id="resetColorsBtn" class="w-full bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition duration-200 ease-in-out">
                        Reset Colors
                    </button>
                </div>
            </div>
        </div>

        <!-- Floating Customization Button -->
        <button id="openPanelBtn" class="fixed bottom-6 right-6 bg-primary-color text-white p-4 rounded-full shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-primary-color focus:ring-opacity-50 z-40">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37zm3.126 10.323a2.5 2.5 0 10-3.398-3.398 2.5 2.5 0 003.398 3.398z"></path></svg>
        </button>
    </div>

</body>
</html>
